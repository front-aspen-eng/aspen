<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>簡易ゲスト検索</title>
  <style>
    :root{font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Noto Sans JP","Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{margin:0;padding:16px;background:#f7f8fb;color:#111}
    .container{max-width:980px;margin:0 auto}
    h1{font-size:20px;margin:0 0 12px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(12,20,30,0.06);margin-bottom:12px}
    label{display:block;font-size:14px;margin-bottom:8px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    input[type=file],select,input[type=text]{padding:10px 12px;border-radius:10px;border:1px solid #e2e6ef;font-size:15px}
    button{padding:10px 12px;border-radius:10px;border:0;background:#0b66ff;color:#fff;font-weight:600;font-size:15px}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px;table-layout:auto}
    th,td{padding:8px 10px;border-bottom:1px solid #eef2f7;text-align:left;vertical-align:middle}
    th{background:#fbfdff;position:sticky;top:0}
    tr:hover{background:#f3f6ff}
    .small{font-size:13px;color:#7b8190}
    /* カナ名列を優先的に見せる。幅は内容に合わせつつ最大で画面の30%に制限。長い場合は省略表示 */
    th.kana-col, td.kana-col{max-width:20%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    @media (max-width:640px){ th.kana-col, td.kana-col{max-width:30%} }
  </style>
</head>
<body>
<div class="container">
  <h1>簡易ゲスト検索</h1>

  <div class="card">
    <label id="date-label">CSVファイルを選択してください</label>
    <div class="controls">
      <input id="fileInput" type="file" accept=".csv,text/csv" />
      <select id="encodingSelect">
        <option value="shift_jis" selected>Shift_JIS（デフォルト）</option>
        <option value="utf-8">UTF-8</option>
      </select>
      <button id="loadBtn">読み込み開始</button>
    </div>
  </div>

  <div class="card" id="searchArea" style="display:none">
    <div class="controls">
      <input id="searchInput" type="text" placeholder="カナ名を入力" autocomplete="off" />
      <button id="clearSearch">×</button>
    </div>
    <div id="resultCount" class="small" style="margin-top:8px"></div>
    <table id="resultTable">
      <thead>
        <tr><th>カナ名</th><th>到着日</th><th>出発日</th><th>泊</th><th>備考</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
let guestData = [];

(function setLabelDate(){
  const t = new Date();
  document.getElementById('date-label').textContent = `${t.getMonth()+1}月${t.getDate()}日のチェックインゲストCSVを選択`;
})();

const fileInput = document.getElementById('fileInput');
const encodingSelect = document.getElementById('encodingSelect');
const loadBtn = document.getElementById('loadBtn');

loadBtn.addEventListener('click', () => {
  const file = fileInput.files && fileInput.files[0];
  if(!file){ alert('CSVファイルを選択してください'); return; }
  loadCSV(file);
});

function loadCSV(file){
  const reader = new FileReader();
  const enc = encodingSelect.value;

  reader.onload = function(e){
    try{
      const arr = e.target.result;
      let text = '';
      try{
        text = new TextDecoder(enc).decode(arr);
      }catch(err){
        try{ text = new TextDecoder('shift_jis').decode(arr); }
        catch{ text = new TextDecoder('utf-8').decode(arr); }
      }
      parseCSV(text);
    }catch(err){
      alert('エラー: ' + err);
    }
  };
  reader.readAsArrayBuffer(file);
}

function splitCSVLine(line){
  const cols = [];
  let cur='', inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i], nx=line[i+1];
    if(ch==='"'){
      if(inQ && nx==='"'){ cur+='"'; i++; }
      else inQ=!inQ;
    } else if(ch===',' && !inQ){ cols.push(cur); cur=''; }
    else cur+=ch;
  }
  cols.push(cur);
  return cols;
}

function stripQuotes(s){
  if(!s) return '';
  s = s.trim();
  if(s.startsWith('"') && s.endsWith('"')) return s.slice(1,-1).replace(/""/g,'"').trim();
  return s;
}

function parseCSV(text){
  // Fix: split by newline (CRLF or LF)
  const lines = String(text).split(/\r?\n/).filter(l=>l.trim()!== '');
  if(lines.length===0){ alert('CSVが空です'); return; }

  const second = splitCSVLine(lines[1]||'').map(stripQuotes);
  if(second.every(v => v.toUpperCase()==='STRING')) lines.splice(1,1);

  const header = splitCSVLine(lines[0]).map(stripQuotes);
  const idx = {
    kana: header.indexOf('カナ名'), arrival: header.indexOf('到着日'),
    depart: header.indexOf('出発日'), nights: header.indexOf('泊'), remarks: header.indexOf('備考')
  };
  if(Object.values(idx).some(v=>v===-1)){
    alert('必要列が見つかりません'); return;
  }

  guestData = lines.slice(1).map(line => {
    const c = splitCSVLine(line).map(stripQuotes);
    return {
      kana:c[idx.kana]||'', arrival:c[idx.arrival]||'', depart:c[idx.depart]||'',
      nights:c[idx.nights]||'', remarks:c[idx.remarks]||''
    };
  });

  document.getElementById('searchArea').style.display='block';
  renderTable(guestData);
}

function toZenkakuKana(str){
  if(!str) return '';
  let s = str.replace(/[ぁ-ゖ]/g, ch=>String.fromCharCode(ch.charCodeAt(0)+0x60));
  return s.replace(/[ｦ-ﾝ]/g, ch=>String.fromCharCode(ch.charCodeAt(0)+0xFEC0));
}

const searchInput = document.getElementById('searchInput');
searchInput.addEventListener('input', ()=>{
  const key = toZenkakuKana(searchInput.value.trim()).toLowerCase();
  if(key===''){ renderTable(guestData); return; }
  const filtered = guestData.filter(g => toZenkakuKana(g.kana).toLowerCase().includes(key));
  renderTable(filtered);
});

document.getElementById('clearSearch').onclick = () =>{
  searchInput.value='';
  renderTable(guestData);
};

function renderTable(list){
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';

  // helper: format yyyy/mm/dd or yyyy-mm-dd -> mm/dd (avoid regex to keep replacement safe)
  function formatMMDD_noRegex(s){
    if(!s) return '';
    const str = String(s).trim();
    if(str.length >= 10 && (str[4] === '/' || str[4] === '-')){
      // assume YYYY/MM/DD or YYYY-MM-DD
      const mm = str.substring(5,7);
      const dd = str.substring(8,10);
      if(mm && dd) return (mm.length===1? '0'+mm: mm) + '/' + (dd.length===1? '0'+dd: dd);
    }
    // fallback: split by / or - and try to pick last two parts
    let sep = '/';
    if(str.indexOf('/') === -1 && str.indexOf('-') !== -1) sep = '-';
    if(str.indexOf(sep) !== -1){
      const parts = str.split(sep).filter(p=>p!=='');
      if(parts.length >= 2){
        // if first part is 4-digit year, remove it
        if(parts[0].length === 4) parts.shift();
        const mm = parts[0] || '';
        const dd = parts[1] || '';
        if(mm && dd) return (mm.length===1? '0'+mm: mm) + '/' + (dd.length===1? '0'+dd: dd);
      }
    }
    return str;
  }

  list.forEach(g =>{
    const tr = document.createElement('tr');

    const tdKana = document.createElement('td');
    tdKana.className = 'kana-col';
    tdKana.textContent = g.kana || '';
    tdKana.title = g.kana || '';
    tr.appendChild(tdKana);

    const tdArrival = document.createElement('td');
    tdArrival.textContent = formatMMDD_noRegex(g.arrival || '');
    tr.appendChild(tdArrival);

    const tdDepart = document.createElement('td');
    tdDepart.textContent = formatMMDD_noRegex(g.depart || '');
    tr.appendChild(tdDepart);

    const tdNights = document.createElement('td');
    tdNights.textContent = g.nights || '';
    tr.appendChild(tdNights);

    const tdRemarks = document.createElement('td');
    tdRemarks.textContent = g.remarks || '';
    tr.appendChild(tdRemarks);

    tbody.appendChild(tr);
  });

  document.getElementById('resultCount').textContent = `${list.length} 件表示`;
}
</script>
</body>
</html>
